# Generated by Chef. To customize, edit the template file hosts.erb, or update_host_file script.
<%- 
  # Leave 18 characters for IP address and space before putting the names
  # INPUT: Hash { String => Array[String] }
  # OUTPUT: String
def format_ip_row(hash)
  hash = hash.sort.to_h
  hash.map do |ip, names|
    names = names.reject(&:nil?) # Sometimes hosts hash has nil values to be removed
    format('%-18s%s', ip, names.join(' '))  
  end.join("\n")
end

LOCAL_IP = '127.0.0.1'
DEFAULT_LOCAL_DOMAINS_V4 = %w[ localhost localhost.localdomain localhost4 localhost4.localdomain4 ]
services = @hosts_entries.dig(LOCAL_IP,'services') || []
v4_local_names = (DEFAULT_LOCAL_DOMAINS_V4 + services).uniq
v4_localhost = { LOCAL_IP => v4_local_names }
@hosts_entries.delete(LOCAL_IP) # Once read, delete

# By default, IPv6 is enabled in Rocky network interfaces
DEFAULT_LOCAL_DOMAINS_V6 = %w[ localhost localhost.localdomain localhost6 localhost6.localdomain6 ]
v6_localhost = { '::1' => DEFAULT_LOCAL_DOMAINS_V6 }

# Sort the domains by type
remote_hosts = {}
@hosts_entries.each do |ip, names|
  domains = []
  domains << names['cdomain'] if names['cdomain']
  domains += names['node_names'] if names['node_names']
  domains += names['services'] if names['services']
  remote_hosts[ip] = domains
end
-%>
<%= format_ip_row(v4_localhost) %>
<%= format_ip_row(v6_localhost) %>
<%= format_ip_row(remote_hosts) %>
